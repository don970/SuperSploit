import json
import subprocess as sub
import time

from ppadb.client import Client as AdbClient

# integrated = True
#!#!#!
# This uses adb to create a remote connection to
# a device that's plugged in via usb
#############################################
# REQUIRED OPTIONS
# ADB_HOST: The host the server runs on
# ADB_PORT: the port the server is running on default
#!#!#!

with open(".data/data.json") as file:
    di = json.load(file)
    file.close()

# Default is "127.0.0.1" and 5037
client = AdbClient(host=di["ADB_HOST"], port=(di["ADB_PORT"]))
devices = client.devices()


# Get device ip address by running ifconfig wlan0 via a adb test
def ip():
    ipp = []
    try:
        for device in devices:
            devicesInfo = str(device.shell('ifconfig wlan0')).split('\n')
            ipp.append(str(devicesInfo[1].split(' ')[11]).split(':')[1])
        return ipp
    except Exception:
        for device in devices:
            ipp.append(str(device.get_serial_no()))
        return ipp


# Connect to a discovered device
def adb_connect():
    ipp = ip()
    if len(ipp) < 1:
        print("no connected devices")
        return
    sub.run(['adb', 'disconnect'])
    for x in ipp:
        print(f"{ipp.index(x)}: {x}")
    inn = input(f"please pick a device: ")
    sub.run(['adb', 'tcpip', '5555'])
    time.sleep(2)
    sub.run(["clear"])
    sub.run([f'adb', 'connect', f'{ipp[int(inn)]}:5555'])


adb_connect()
