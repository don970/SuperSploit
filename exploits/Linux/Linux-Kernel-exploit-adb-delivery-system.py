import json
import os
from subprocess import run

from ppadb.client import Client as AdbClient

# integrated = True
#!#!#!
# This uses adb to create a connection to
# a device that's plugged in via usb and attempts to
# deliver the selected exploit via adb shell
######################################################
# REQUIRED OPTIONS
# SH_PROGRAM: bash or shell script being used to run the exploit
# SH_LOCATION: location on the target device to save the exploit
# EXTRA_FILES: Any extra files needed by exploit ie native code files ect
# EXTRA_FILES_LOCATION: Location to store extra files on target device

#!#!#!
with open(".data/data.json") as file:
    di = json.load(file)
    file.close()


# Default is "127.0.0.1" and 5037
client = AdbClient(host=di["ADB_HOST"], port=int(di["ADB_PORT"]))
devices = client.devices()

if len(devices) > 1:
    de = devices[int(input("Enter device index: "))]
else:
    de = devices[0]
installation = f'{os.getenv("HOME")}/.SuperSploit'
sh_programs = []
for i in os.listdir(f"{installation}/exploits/Linux"):
    if i.endswith(".sh"):
        sh_programs.append(i)
for y in sh_programs:
    print(f"{sh_programs.index(y)}:{y}")
de.push(f'{installation}/{di["SH_PROGRAM"]}', di["SH_LOCATION"])

run(["adb", "-s", de.get_serial_no(), "shell", "sh", di["SH_LOCATION"]])
